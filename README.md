# 音声文字起こし用オーディオ前処理ツール

MP4動画ファイルから音声を抽出し、文字起こしに最適な音質に加工するPython製CLIツールです。

## 特徴

- **MP4からの音声抽出**: 動画ファイルから音声データのみを取得
- **ノイズ除去**: 背景ノイズを除去してクリアな音源に
- **音量正規化**: 音量レベルを適切に調整
- **ダイナミックレンジ圧縮**: 音圧を最適化して聞き取りやすく
- **無音部分除去**: 長い沈黙を削除または短縮
- **詳細な進捗表示**: 各処理ステップの進行状況と処理時間を表示
- **カスタマイズ可能**: 各処理のパラメータを細かく調整可能

## 必要な環境

- Python 3.7以上
- FFmpeg（音声処理に必要）

### FFmpegのインストール

#### macOS
```bash
brew install ffmpeg
```

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install ffmpeg
```

#### Windows
1. [FFmpeg公式サイト](https://ffmpeg.org/download.html)からダウンロード
2. 環境変数PATHに追加

## インストール

1. リポジトリをクローン
```bash
git clone <このリポジトリのURL>
cd mp4-audio-optimization-tool
```

2. 依存ライブラリをインストール
```bash
pip install -r requirements.txt
```

## 基本的な使用方法

```bash
python audio_processor.py input.mp4
```

デフォルトでは `input_processed.wav` という名前で出力されます。

## コマンドラインオプション

### 基本オプション

| オプション | 説明 | デフォルト値 |
|----------|------|------------|
| `-o, --output` | 出力ファイル名 | `入力ファイル名_processed.wav` |
| `-v, --verbose` | 詳細なログ出力 | オフ |

### 処理スキップオプション

| オプション | 説明 |
|----------|------|
| `--no-noise-reduction` | ノイズ除去をスキップ |
| `--no-silence-removal` | 無音除去をスキップ |

### パラメータ調整オプション

| オプション | 説明 | デフォルト値 |
|----------|------|------------|
| `--silence-threshold` | 無音判定の閾値（dBFS） | -40 |
| `--min-silence-len` | 無音として認識する最小時間（ミリ秒） | 500 |
| `--keep-silence` | 無音部分を残す時間（ミリ秒） | 100 |
| `--normalize-level` | 正規化のターゲットレベル（dBFS） | -20.0 |

### その他のオプション

| オプション | 説明 |
|----------|------|
| `--save-intermediate` | 中間ファイルを保存（デバッグ用） |

## 使用例

### 基本的な使用
```bash
python audio_processor.py video.mp4
```

### 出力ファイル名を指定
```bash
python audio_processor.py video.mp4 -o output.wav
```

### ノイズ除去をスキップして処理を高速化
```bash
python audio_processor.py video.mp4 --no-noise-reduction
```

### 無音除去の閾値を調整（静かな音声の場合）
```bash
python audio_processor.py video.mp4 --silence-threshold -35
```

### 無音除去を厳しく設定（より多くの無音を削除）
```bash
python audio_processor.py video.mp4 --silence-threshold -45 --min-silence-len 1000
```

### 中間ファイルを保存して処理過程を確認
```bash
python audio_processor.py video.mp4 --save-intermediate -v
```

### すべての処理をカスタマイズ
```bash
python audio_processor.py video.mp4 \
  -o custom_output.wav \
  --silence-threshold -35 \
  --min-silence-len 800 \
  --keep-silence 150 \
  --normalize-level -18.0 \
  -v
```

## 処理フロー

1. **入力ファイルの検証**: ファイルの存在確認と形式チェック
2. **音声抽出**: MP4から音声トラックを抽出 → `temp_audio.wav`
3. **ノイズ除去**: 背景ノイズを除去 → `denoised.wav`
4. **音量正規化**: 音量レベルを調整 → `normalized.wav`
5. **ダイナミックレンジ圧縮**: 音圧を最適化
6. **無音部分除去**: 長い沈黙を削除 → 最終出力ファイル
7. **クリーンアップ**: 中間ファイルの削除（`--save-intermediate`指定時は保持）

## パラメータ調整のヒント

### 無音除去の閾値 (`--silence-threshold`)

- **-40 dBFS** (デフォルト): 通常の音声に適しています
- **-35 dBFS**: 静かな音声や小さな音も保持したい場合
- **-45 dBFS**: より厳密に無音を除去したい場合

### 無音の最小時間 (`--min-silence-len`)

- **500 ms** (デフォルト): 通常の会話に適しています
- **300-400 ms**: テンポの速い会話の場合
- **1000 ms以上**: プレゼンテーションなど、長い間を削除したい場合

### 正規化レベル (`--normalize-level`)

- **-20.0 dBFS** (デフォルト): 文字起こしサービスに適した標準的なレベル
- **-18.0 dBFS**: より大きな音量が必要な場合
- **-23.0 dBFS**: より小さな音量にしたい場合

## 出力例

```
============================================================
音声文字起こし用オーディオ前処理ツール
============================================================

入力ファイル: video.mp4
  サイズ: 125.45 MB
  時間: 180.50 秒 (3.01 分)

[1/6] MP4から音声を抽出中...
  完了 (12.34秒)

[2/6] ノイズを除去中...
  完了 (45.67秒)

[3/6] 音量を正規化中 (目標: -20.0 dBFS)...
  完了 (8.90秒)

[4/6] ダイナミックレンジを圧縮中...
  完了 (9.12秒)

[5/6] 無音部分を除去中...
  完了 (15.34秒)

[6/6] 処理を完了しています...

============================================================
処理が完了しました!
============================================================

出力ファイル: video_processed.wav
  サイズ: 18.23 MB
  時間: 165.30 秒 (2.76 分)

処理時間: 91.37秒

ファイルサイズ変化: 125.45 MB → 18.23 MB
  圧縮率: 14.5%

音声時間の削減: 15.20秒 (0.25分)
```

## トラブルシューティング

### FFmpegが見つからないエラー

**エラーメッセージ:**
```
FFmpegがインストールされていない可能性があります。
```

**解決方法:**
- FFmpegをインストールしてください（上記の「FFmpegのインストール」を参照）
- インストール後、環境変数PATHが正しく設定されているか確認してください

### 音声全体が無音として検出される

**エラーメッセージ:**
```
警告: 音声全体が無音として検出されました。閾値を調整してください。
```

**解決方法:**
- `--silence-threshold` の値を下げてください（例: -35 または -30）
- または `--no-silence-removal` で無音除去をスキップしてください

### メモリ不足エラー

**症状:**
- 大きなファイルの処理中にメモリエラーが発生する

**解決方法:**
- より大きなメモリを持つマシンで実行する
- または、動画を分割して処理する

### 処理に時間がかかりすぎる

**解決方法:**
- `--no-noise-reduction` でノイズ除去をスキップ（最も時間のかかる処理）
- または、より高速なマシンで実行する

## 依存ライブラリ

- `moviepy>=1.0.3` - 動画処理
- `noisereduce>=3.0.0` - ノイズ除去
- `pydub>=0.25.1` - 音声処理
- `numpy>=1.24.0` - 数値計算

これらのライブラリは `requirements.txt` に記載されており、`pip install -r requirements.txt` で一括インストールできます。

## ライセンス

このプロジェクトのライセンスについては、LICENSEファイルを参照してください。

## 貢献

バグ報告や機能リクエストは、GitHubのIssueページでお願いします。

## 注意事項

- このツールは音声の品質を改善しますが、元の音声が極端に低品質な場合、完全な改善は期待できません
- ノイズ除去は有用ですが、場合によっては音声の一部も削除される可能性があります
- パラメータは音声の特性に応じて調整してください
